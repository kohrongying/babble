<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description"><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Learning Docker [Part 2]</title><link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.1"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpeg"></div><div class="author"><div class="author-name"><a href="/">rongying</a></div><div class="about-me">just a plebeian</div></div></div><div class="header-right"><ul class="navigation"><li><a href="archives">Archives</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpeg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/kohrongying"></span><a href="https://github.com/kohrongying" target="_blank" title="https://github.com/kohrongying">https://github.com/kohrongying</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="kohrongying@gmail.com"></span><span>kohrongying@gmail.com</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Learning Docker [Part 2]</div><div class="date">2018-12-24</div><div class="content"><h2 id="tldr"><a href="#tldr" class="headerlink" title="tldr;"></a>tldr;</h2><p>Learning how to move your dockerized flask containers to a Digital Ocean Droplet.<a id="more"></a></p>
<p>Link to the dockerized flask app is <a href="https://github.com/kohrongying/docker-flask" target="_blank" rel="noopener">here</a></p>
<h2 id="Aims"><a href="#Aims" class="headerlink" title="Aims"></a>Aims</h2><p>To deploy a container for a web application into the Internet, we need:</p>
<p>1) A docker host server to run the container (Host VM has to have docker installed)<br>2) A Docker Image (can be pulled from dockerhub or built from a Dockerfile)</p>
<p>We’re going to host on Digital Ocean and create our host using <code>docker-machine</code>. </p>
<h2 id="Deploying-to-Digital-Ocean"><a href="#Deploying-to-Digital-Ocean" class="headerlink" title="Deploying to Digital Ocean"></a>Deploying to Digital Ocean</h2><h3 id="Generating-DO-Personal-Access-Token"><a href="#Generating-DO-Personal-Access-Token" class="headerlink" title="Generating DO Personal Access Token"></a>Generating DO Personal Access Token</h3><p>Go to <a href="https://cloud.digitalocean.com/account/api/tokens" target="_blank" rel="noopener">here</a> to get yours now! [#notsponsored]</p>
<h3 id="docker-machine"><a href="#docker-machine" class="headerlink" title="docker-machine"></a>docker-machine</h3><p>Run below command to create a digital ocean droplet in your account with docker installation configured! Other configurations like adding ssh key fingerprints also exist. :)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create --driver digitalocean </span><br><span class="line">--digitalocean-access-token &lt;token&gt; </span><br><span class="line">--digitalocean-region sgp1 </span><br><span class="line">--digitalocean-size s-1vcpu-1gb </span><br><span class="line">docker-flask</span><br></pre></td></tr></table></figure></p>
<h3 id="Configure-your-shell"><a href="#Configure-your-shell" class="headerlink" title="Configure your shell"></a>Configure your shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ eval $(docker-machine env docker-flask)</span><br></pre></td></tr></table></figure>
<p><img src="https://media.giphy.com/media/555sbTLpqqwODaHIvc/giphy.gif" alt="Important!"></p>
<p>This is the one key step (!!!) env returns a bunch of environment variables belonging to that docker-machine, evaluating it is akin to connecting to your remote machine (like you’ve ssh-ed in).</p>
<p>One method of understanding this command, is through the example of running a hello word instance</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ eval $(docker-machine env docker-flask)</span><br><span class="line">$ docker run -d -p 8000:80 --name webserver kitematic&#x2F;hello-world-nginx</span><br></pre></td></tr></table></figure>
<p>Navigating to the <code>&lt;droplet-ip&gt;:8000</code> will show you a hello world instance, while <code>localhost:8000</code> will not be reached. This shows that you just ran that command in the host machine’s terminal. It’s magical! </p>
<h4 id="Unset-Docker-Variables"><a href="#Unset-Docker-Variables" class="headerlink" title="Unset Docker Variables"></a>Unset Docker Variables</h4><p>In order to return to your own machine, you have to:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ eval &quot;$(docker-machine env -u)&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="Run-Docker-commands-on-droplet"><a href="#Run-Docker-commands-on-droplet" class="headerlink" title="Run Docker commands on droplet"></a>Run Docker commands on droplet</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ docker-machine ls</span><br><span class="line"></span><br><span class="line">$ docker-machine ip docker-flask</span><br><span class="line"></span><br><span class="line">178.128.116.60</span><br><span class="line"></span><br><span class="line">$ docker-machine inspect docker-flask</span><br><span class="line"></span><br><span class="line">$ docker-machine start docker-flask</span><br><span class="line"></span><br><span class="line">$ docker-machine stop docker-flask</span><br></pre></td></tr></table></figure>
<h2 id="Running-Containers"><a href="#Running-Containers" class="headerlink" title="Running Containers"></a>Running Containers</h2><p>So all that’s left to do is to run the containers in the background! </p>
<p><code>docker-compose up -d</code></p>
<p>Go to the live site and you should see it going strong! The initial load time is kinda slow. :/ </p>
<h2 id="Tear-Down"><a href="#Tear-Down" class="headerlink" title="Tear Down"></a>Tear Down</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine kill docker-flask</span><br><span class="line"></span><br><span class="line">$ docker-machine rm docker-flask</span><br></pre></td></tr></table></figure>
<p>Remove will remove both the local and remote instance. Yay! No traces of evidence of tampering with our DO account ahaha (a few cents only I hope shhh)</p>
<p><img src="https://media.giphy.com/media/WJK2SABYwvEvm/giphy.gif" alt="So easy?!"></p>
<p>Can’t believed it worked! Yay, here we learnt how we moved all our containers to a hosted machine (hosted by DO) and all the commands were done through our own terminal and thanks to <code>docker-machine</code>. </p>
<p>Docker Compose can deploy and scale containers running on a single machine, so what if we want to handle multi-container applications deployed across multiple droplets? </p>
<h2 id="Docker-Swarm"><a href="#Docker-Swarm" class="headerlink" title="Docker Swarm"></a>Docker Swarm</h2><p>Docker Swarm is essentially like kubernetes, a container orchestration tool. But much simpler, and because we built our images with docker-compose, it is also much easier to use docker swarm to provision the multiple vms. </p>
<h3 id="Push-your-images-to-registry"><a href="#Push-your-images-to-registry" class="headerlink" title="Push your images to registry"></a>Push your images to registry</h3><p>Go to <a href="">Docker Hub</a>, sign up for a new account and create a new repo. </p>
<p>Remember to <code>docker login</code> with your credentials!</p>
<p>In order to push your image up, you have two ways of doing it. </p>
<ol>
<li>Build the image using the Dockerfile (Recommended)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t &lt;username&gt;&#x2F;repo:latest .</span><br></pre></td></tr></table></figure></li>
<li>Tag the image if it already exists</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag repo:latest &lt;username&gt;&#x2F;repo</span><br></pre></td></tr></table></figure>
<p>Last Step<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker push &lt;username&gt;&#x2F;repo:latest</span><br></pre></td></tr></table></figure></p>
<h3 id="Create-multiple-droplets"><a href="#Create-multiple-droplets" class="headerlink" title="Create multiple droplets"></a>Create multiple droplets</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine create --driver digitalocean  </span><br><span class="line">--digitalocean-access-token &lt;token&gt; </span><br><span class="line">--digitalocean-region sgp1 </span><br><span class="line">--digitalocean-size s-1vcpu-1gb </span><br><span class="line">--digitalocean-ssh-key-fingerprint &lt;fi:ng:er:pr:int&gt; </span><br><span class="line">vm1</span><br><span class="line"></span><br><span class="line">$ docker-machine create --driver digitalocean  </span><br><span class="line">--digitalocean-access-token &lt;token&gt;</span><br><span class="line">--digitalocean-region sgp1 </span><br><span class="line">--digitalocean-size s-1vcpu-1gb </span><br><span class="line">--digitalocean-ssh-key-fingerprint &lt;fi:ng:er:pr:int&gt; </span><br><span class="line">vm2</span><br></pre></td></tr></table></figure>
<h3 id="Docker-Swarm-Init"><a href="#Docker-Swarm-Init" class="headerlink" title="Docker Swarm Init"></a>Docker Swarm Init</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ip vm1</span><br><span class="line"></span><br><span class="line">$ docker-machine ssh vm1 &quot;docker swarm init --advertise-addr &lt;vm1-ip&gt;&quot;</span><br><span class="line"></span><br><span class="line">$ docker-machine ssh vm2 &quot;docker swarm join --token &lt;token&gt; &lt;vm1-ip&gt;:&lt;port&gt;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="Deploying-to-the-Swarm"><a href="#Deploying-to-the-Swarm" class="headerlink" title="Deploying to the Swarm"></a>Deploying to the Swarm</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ eval $(docker-machine env vm1)</span><br><span class="line"></span><br><span class="line">$ docker stack deploy --with-registry-auth -c docker-compose.yml myapp</span><br><span class="line"></span><br><span class="line">$ docker stack ps myapp</span><br></pre></td></tr></table></figure>
<p>And wala! Its all deployed to your cluster.</p>
<p>Some ways you can debug:</p>
<ul>
<li><code>docker stack ls</code></li>
<li><code>docker service ls</code></li>
<li><code>docker stack rm myapp</code></li>
<li><code>docker node|stack|service ps --no-trunc</code> </li>
</ul>
<h3 id="Scaling-services"><a href="#Scaling-services" class="headerlink" title="Scaling services"></a>Scaling services</h3><p>Another thing you can add to the <code>docker-compose.yml</code> file is the deploy attribute. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy: </span><br><span class="line">  replicas: 5</span><br><span class="line">  restart_policy:</span><br><span class="line">    condition: on-failure</span><br></pre></td></tr></table></figure>
<p>Another method is through the docker cli.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service scale myapp_redis&#x3D;2</span><br></pre></td></tr></table></figure></p>
<p>Magically, you should see the Flask Dockerized on both VM IP addresses! Cool. Okay we had a hard time deploying it because the nginx image was not the correct one :( </p>
<h2 id="End-of-Part-2"><a href="#End-of-Part-2" class="headerlink" title="End of Part 2"></a>End of Part 2</h2><p>Here, we learnt <code>docker-machine</code> and <code>docker swarm</code>!</p>
<h2 id="Docker-Services"><a href="#Docker-Services" class="headerlink" title="Docker Services"></a>Docker Services</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker services ls</span><br><span class="line">$ docker service update --image &lt;repo&#x2F;name&gt; &lt;service name&gt;</span><br></pre></td></tr></table></figure></div><div class="tags"><a class="tag-link" href="/tags/docker/" rel="tag">docker</a><a class="tag-link" href="/tags/flask/" rel="tag">flask</a></div></section></div><div class="container"><ul class="nav"><li>Another one:<a href="/2019/01/14/dockerize-rails/">Circle CI Workflow With Ruby on Rails and Docker</a></li><li>Previous one:<a href="/2018/12/22/dockerize-flask-part-one/">Learning Docker [Part 1]</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-curry" target="_blank">Curry</a><span>.</span></div></footer>
<script src="/script/jquery.min.js"></script>

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script src="/script/index.js"></script>
<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-109820124-3', 'auto');
ga('send', 'pageview');</script>
<script src="/script/jquery.min.js"></script>

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script src="/script/index.js"></script>

<script src="/script/post.js"></script>
</body></html>