<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="description"><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Google Cloud Functions + Scheduler</title><link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpeg"></div><div class="author"><div class="author-name"><a href="/">rongying</a></div><div class="about-me">just a plebeian</div></div></div><div class="header-right"><ul class="navigation"><li><a href="archives">Archives</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpeg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/kohrongying"></span><a href="https://github.com/kohrongying" target="_blank" title="https://github.com/kohrongying">https://github.com/kohrongying</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="kohrongying@gmail.com"></span><span>kohrongying@gmail.com</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Google Cloud Functions + Scheduler</div><div class="date">2019-09-16</div><div class="content"><p>This week at work I had a new task and got to try out Google Cloud Functions and Scheduler (Cron Job).<a id="more"></a></p>
<h2 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h2><ol>
<li>Scrape website</li>
<li>Use Sheets API to update cells in Google Sheet</li>
<li>Repeat step 1 - 2 once a week</li>
</ol>
<h2 id="Python-Web-Scraping"><a href="#Python-Web-Scraping" class="headerlink" title="Python Web Scraping"></a>Python Web Scraping</h2><p>For this task, I used requests and Beautiful Soup to parse the html. </p>
<p>However, one setback I faced was that the website was behind Cloudflare’s service provider so it prevented me from using requests to read the contents of the html file. </p>
<p>Luckily there was another package, <a href="https://github.com/Anorov/cloudflare-scrape" target="_blank" rel="noopener">Cloudflare Scrape</a>, that allowed us to bypass cloudflare bots.</p>
<h2 id="Google-Sheets-API"><a href="#Google-Sheets-API" class="headerlink" title="Google Sheets API"></a>Google Sheets API</h2><p>I installed the python client for GCP’s API and various other libraries in order to get it to work.</p>
<p>First, enable the Google Sheets API.</p>
<p>Second, the <code>quickstart.py</code> code from Google would read a <code>token.pickle</code> file (if any, else create one from the credentials file - you have to download it from GCP) to authenticate the user. </p>
<p>The tip from Google was to do batch updates and batch gets from Sheets API. My data was spread over 8-10 different sheets in one Google Sheet file. Hence, using batch get and update was going to help performance wise (not that I tested it)</p>
<h2 id="Google-Cloud-Functions"><a href="#Google-Cloud-Functions" class="headerlink" title="Google Cloud Functions"></a>Google Cloud Functions</h2><p>With the increasing focus on breaking up monoliths, microservices and serverless, I decided to go with Google Cloud Function, having used alot of Firebase Functions during work as well. </p>
<p>In order to deploy a function, create a <code>main.py</code> file and add a function in there with a request argument if you would require the arguments or body of the incoming request. Add packages you used into <code>requirements.txt</code> file (the python environment in the Cloud will install these before configuring your function). (Tip: If you’re in a virtual environment, use <code>pip freeze &gt; requirements.txt</code> to save all the dependencies into the text file)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># requirements.txt</span></span><br><span class="line">beautifulsoup4==<span class="number">4.8</span><span class="number">.0</span></span><br><span class="line">bs4==<span class="number">0.0</span><span class="number">.1</span></span><br><span class="line">cfscrape==<span class="number">2.0</span><span class="number">.8</span></span><br><span class="line">google-api-python-client==<span class="number">1.7</span><span class="number">.11</span></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line"><span class="comment"># main.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_get</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="string">'Hello World'</span>, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>
<p>To deploy, run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcloud functions deploy hello_get \</span><br><span class="line">      --runtime python37 --trigger-http</span><br></pre></td></tr></table></figure></p>
<p>So, I refactored some code and made sure one main function called the scraping function and the subsequent batch get and update functions. </p>
<p>I ran into issues with the Google Sheets API. It is complaining that it couldn’t read <code>credentials.json</code> file anymore. So I had to use another way to authenticate the function to allow it to read and write to the Google Sheet.</p>
<h3 id="Autheticating-for-Google-Sheets"><a href="#Autheticating-for-Google-Sheets" class="headerlink" title="Autheticating for Google Sheets"></a>Autheticating for Google Sheets</h3><p>In the GCP Project, create a new service account. Share the google sheet with the email address of the new service account created. </p>
<p>And that’s all! In my code, I don’t have to use any other keys or creds because the function belonging to the GCP has permissions to the google sheet already. </p>
<h3 id="Securing-the-endpoint"><a href="#Securing-the-endpoint" class="headerlink" title="Securing the endpoint"></a>Securing the endpoint</h3><p>I read in an article somewhere to secure the endpoint in the most basic way. I did not want anyone to just hit the endpoint easily. Two ways:</p>
<p>1) Append random alphanumeric characters to the function<br>People won’t be able to guess the endpoint now.</p>
<p>2) Send a hardcoded token in the query param of the endpoint<br>Check that <code>request.args.get(&#39;token&#39;, &#39;&#39;) == hardcoded_token</code>, then proceed to run the rest of the function</p>
<p>Get random number<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 48 | tr -d /=+ | cut -c -32</span><br></pre></td></tr></table></figure></p>
<h2 id="Cron-Job"><a href="#Cron-Job" class="headerlink" title="Cron Job"></a>Cron Job</h2><p>To deploy the cron job:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcloud beta scheduler jobs create http &lt;cronjobName&gt; \</span><br><span class="line">       --schedule=&quot;0 7 * * 1&quot; \</span><br><span class="line">       --uri=&lt;uri&gt;</span><br><span class="line">       --time-zone=&quot;Asia/Singapore&quot;</span><br></pre></td></tr></table></figure></p>
<p>Otherwise, you can use GCP Portal to configure the cronjob too!</p>
<p>That ends this post. Chill out peeps.</p>
<p><img src="https://media.giphy.com/media/3o7btYRcGPDrQ0YTy8/giphy.gif" alt="AMAHZING"></p>
</div><div class="tags"><a class="tag-link" href="/tags/google-cloud-functions/">google-cloud-functions</a><a class="tag-link" href="/tags/google-cloud-scheduler/">google-cloud-scheduler</a><a class="tag-link" href="/tags/python/">python</a><a class="tag-link" href="/tags/sheets-api/">sheets api</a></div></section></div><div class="container"><ul class="nav"><li>Another one:<a href="/2019/11/03/Building-with-Svelte/">Building With Svelte</a></li><li>Previous one:<a href="/2019/08/30/2019-8-Hello-Sentry/">Hello Sentry</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-curry" target="_blank">Curry</a><span>.</span></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-109820124-3', 'auto');
ga('send', 'pageview');</script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>