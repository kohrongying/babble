<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="description"><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Scraping Social Media Comments</title><link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpeg"></div><div class="author"><div class="author-name"><a href="/">rongying</a></div><div class="about-me">just a plebeian</div></div></div><div class="header-right"><ul class="navigation"><li><a href="archives">Archives</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpeg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/kohrongying"></span><a href="https://github.com/kohrongying" target="_blank" title="https://github.com/kohrongying">https://github.com/kohrongying</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="kohrongying@gmail.com"></span><span>kohrongying@gmail.com</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Scraping Social Media Comments</div><div class="date">2020-03-13</div><div class="content"><p>Scraping Facebook and Instagram comments is not an uncommon thing - especially for social media companies.<a id="more"></a> Ever since Facebook acquired Instagram, you can now query for comments, insights etc from the Graph API, with the right endpoints.</p>
<h2 id="Facebook-Comments"><a href="#Facebook-Comments" class="headerlink" title="Facebook Comments"></a>Facebook Comments</h2><p>There are three easy steps: </p>
<h4 id="1-Get-an-access-token"><a href="#1-Get-an-access-token" class="headerlink" title="1. Get an access token"></a>1. Get an access token</h4><p>You have to be a page admin/editor of the post and generate one with the <a href="https://developers.facebook.com/docs/facebook-login/access-tokens/" target="_blank" rel="noopener">correct permissions</a>.</p>
<p>Get your access token in the <a href="https://developers.facebook.com/tools/explorer/" target="_blank" rel="noopener">Graph API Explorer</a> and extend the validity of it in the <a href="https://developers.facebook.com/tools/debug/accesstoken/" target="_blank" rel="noopener">Access Token Debugger</a> to up to 2 months / 60 days.</p>
<h4 id="2-Find-the-Facebook-post-ID"><a href="#2-Find-the-Facebook-post-ID" class="headerlink" title="2. Find the Facebook post ID"></a>2. Find the Facebook post ID</h4><p>Get the correct URL by clicking on the timestamp of the post (eg 3 hrs ago, or March 7 - usually found underneath the author’s name)</p>
<p>Wrong URL</p>
<ul>
<li><a href="https://www.facebook.com/sgag.sg/photos/a.378177495530578/3417377514943879/?type=3&amp;theater" target="_blank" rel="noopener">https://www.facebook.com/sgag.sg/photos/a.378177495530578/3417377514943879/?type=3&amp;theater</a></li>
</ul>
<p>Correct </p>
<ul>
<li><a href="https://www.facebook.com/sgag.sg/posts/3417379501610347" target="_blank" rel="noopener">https://www.facebook.com/sgag.sg/posts/3417379501610347</a></li>
</ul>
<p>The post ID is then the last digits in the URL: <code>3417379501610347</code></p>
<h4 id="3-Get-comments-endpoint"><a href="#3-Get-comments-endpoint" class="headerlink" title="3. Get comments endpoint"></a>3. Get comments endpoint</h4><p>Endpoint:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://graph.facebook.com/v5.0/&#123;postId&#125;/comments?</span><br><span class="line">fields=comment_count,like_count,created_time,message,permalink_url&amp;summary=1&amp;access_token=&#123;FBTOKEN&#125;</span><br></pre></td></tr></table></figure></p>
<p>The fields are added as I thought they were helpful.</p>
<h4 id="4-Paginate"><a href="#4-Paginate" class="headerlink" title="4. Paginate"></a>4. Paginate</h4><p>Check if an after is included under paging &gt; cursors &gt; after.<br>Here’s a short code snippet written in js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> response;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">`https://graph.facebook.com/v5.0/<span class="subst">$&#123;postId&#125;</span>/comments?fields=comment_count,like_count,created_time,message,permalink_url&amp;summary=1&amp;access_token=<span class="subst">$&#123;process.env.FBTOKEN&#125;</span>`</span>;</span><br><span class="line">  response = <span class="keyword">await</span> axios.get(url);</span><br><span class="line">  <span class="keyword">let</span> data = response.data.data;</span><br><span class="line">  <span class="keyword">while</span> (response.data.data.length !== <span class="number">0</span>) &#123;</span><br><span class="line">    response = <span class="keyword">await</span> axios.get(url + <span class="string">"&amp;after="</span> + response.data.paging.cursors.after);</span><br><span class="line">    data = [...data, ...response.data.data];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// USE data</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error.response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Yay! No external libraries, just graph API with a token that expires in 60 days ¯\_(ツ)_/¯</p>
<h2 id="Instagram-Comments"><a href="#Instagram-Comments" class="headerlink" title="Instagram Comments"></a>Instagram Comments</h2><p>The process to getting instagram post comments with Graph API is very similar. The only problem was that I spent too much time finding the post ID. </p>
<p>We regularly see the instagram url for posts all end with a 11 digit shortcode eg: <code>https://www.instagram.com/p/B9qN5JFhfWz/</code>. My first idea was to find a way to convert the shortcode <code>B9qN5JFhfWz</code> into a numeric ID. A simple google search lead me to <a href="https://carrot.is/coding/instagram-ids.html" target="_blank" rel="noopener">this article</a>. </p>
<p>Problem is the 19-digit ID decoded from the shortcode <code>B9qN5JFhfWz</code> was not the post id! </p>
<p>(assuming access token is acquired with the instagram basic permission)</p>
<h4 id="1-Getting-Instagram-User-ID"><a href="#1-Getting-Instagram-User-ID" class="headerlink" title="1. Getting Instagram User ID"></a>1. Getting Instagram User ID</h4><p>On <a href="https://developers.facebook.com/tools/explorer/" target="_blank" rel="noopener">Graph API Explorer</a> find the <code>ig-user-id</code><br><code>/{fb-page-name}?fields=instagram_business_account</code></p>
<h4 id="2-Getting-Instagram-Media"><a href="#2-Getting-Instagram-Media" class="headerlink" title="2. Getting Instagram Media"></a>2. Getting Instagram Media</h4><p>On <a href="https://developers.facebook.com/tools/explorer/" target="_blank" rel="noopener">Graph API Explorer</a> find the list of media:<br><code>/{ig-user-id}/media</code></p>
<p>TADA! This will return a list of facebook post-id for those instagram posts.</p>
<p>For extra clarity, do this:<br><code>/{ig-user-id}/media?fields=ig_id,shortcode</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;ig_id&quot;: &quot;2263774239079764498&quot;,</span><br><span class="line">      &quot;shortcode&quot;: &quot;B9qiq0sB5IS&quot;,</span><br><span class="line">      &quot;id&quot;: &quot;17870822104623583&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;ig_id&quot;: &quot;2263727042707413494&quot;,</span><br><span class="line">      &quot;shortcode&quot;: &quot;B9qX8BpBVn2&quot;,</span><br><span class="line">      &quot;id&quot;: &quot;17953709776315597&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;ig_id&quot;: &quot;2263682864078255539&quot;,</span><br><span class="line">      &quot;shortcode&quot;: &quot;B9qN5JFhfWz&quot;,</span><br><span class="line">      &quot;id&quot;: &quot;17859657886776538&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>id</code> is the post-id given by Facebook which will return the comments. The <code>ig_id</code> is the 19-digit that can potentially be decoded from the 11-digit shortcode. It took me hours to understand how my base64 conversion of a 11-digit shortcode could lead to a 17-digit id.</p>
<p>The lesson learnt was not to question myself and to think of the problem rationally, step-by-step. The shortcode is made of 0-9a-Z-_ (which is obviously base64). That part was correct. </p>
<p>I reached my epiphany when I queried <code>https://api.instagram.com/oembed?url=http://instagr.am/p/B9qN5JFhfWz/</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;: &quot;1.0&quot;,</span><br><span class="line">  &quot;media_id&quot;: &quot;2263682864078255539_293188374&quot;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I found out the id returned is truly my 19 digit number decoded from the shortcode. AHA!</p>
<p>I suddenly understood that even though fb acquired ig, the ig-id is not used by fb. Fb has formulated a new id to each ig post.</p>
<p>The only way to query ig comments based on an ig url, is to query for all media, with the shortcode field, and match it to the post id based on the query.</p>
<p>¯\_(ツ)_/¯</p>
<p>A painful lesson nonetheless hahaha.</p>
</div><div class="tags"><a class="tag-link" href="/tags/facebook/">facebook</a><a class="tag-link" href="/tags/instagram/">instagram</a><a class="tag-link" href="/tags/javascript/">javascript</a></div></section></div><div class="container"><ul class="nav"><li>Another one:<a href="/2020/06/03/Why-you-should-consider-antd-in-a-React-project/">Why You Should Consider Antd in a React Project</a></li><li>Previous one:<a href="/2020/02/23/Implementing-Role-Based-Authorization/">Implementing Role-Based Authorization</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-curry" target="_blank">Curry</a><span>.</span></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-109820124-3', 'auto');
ga('send', 'pageview');</script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>