<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="description"><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Implementing Role-Based Authorization</title><link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpeg"></div><div class="author"><div class="author-name"><a href="/">rongying</a></div><div class="about-me">just a plebeian</div></div></div><div class="header-right"><ul class="navigation"><li><a href="archives">Archives</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpeg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/kohrongying"></span><a href="https://github.com/kohrongying" target="_blank" title="https://github.com/kohrongying">https://github.com/kohrongying</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="kohrongying@gmail.com"></span><span>kohrongying@gmail.com</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Implementing Role-Based Authorization</div><div class="date">2020-02-23</div><div class="content"><p>At work, I was tasked to build an authorization feature for a project.<a id="more"></a> I did some research and wanted to share my approach to doing things.</p>
<p>Context: a rails backend api and a reactjs frontend. All api requests are authenticated then authorized. The frontend will also store the user’s role and display different links on the sidebar for different roles.</p>
<h2 id="Backend-Design"><a href="#Backend-Design" class="headerlink" title="Backend Design"></a>Backend Design</h2><h3 id="Designing-the-Models"><a href="#Designing-the-Models" class="headerlink" title="Designing the Models"></a>Designing the Models</h3><img src="/2020/02/23/Implementing-Role-Based-Authorization/diagram.svg" title="model image">
<p>I decided against using available gems like cancancan or pundit as I wanted a simple implementation without the use of external libraries. </p>
<p>This design allowed a user to have multiple roles. Each role will then have a set of different permissions.</p>
<p>First, I expose the user’s permissions through the model file, through the roles table.<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user.rb</span></span><br><span class="line">has_and_belongs_to_many <span class="symbol">:roles</span></span><br><span class="line">has_many <span class="symbol">:permissions</span>, <span class="symbol">through:</span> <span class="symbol">:roles</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># role.rb</span></span><br><span class="line">has_and_belongs_to_many <span class="symbol">:users</span></span><br><span class="line">has_and_belongs_to_many <span class="symbol">:permissions</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># permission.rb</span></span><br><span class="line">has_and_belongs_to_many <span class="symbol">:roles</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Authorizing-the-Controllers"><a href="#Authorizing-the-Controllers" class="headerlink" title="Authorizing the Controllers"></a>Authorizing the Controllers</h3><p>I read some articles and decided to put the authorization logic as part of rails concerns and include it in the application controller.</p>
<p>Each action in the controller will be authorized by a Permission, rather than a Role. Using Permission to authorize routes give a certain level of flexiblity and modularity - we don’t have to create new roles to fit authorization rules. We can just change the permissions that each role can take on.</p>
<p>The next thing was to figure out how to define permissions. My first thought that came to mind was for each model, have a UserRead or UserWrite, that will differentiate the index/show methods from the create/update/destroy methods. </p>
<p>That method is limiting as if your application has over 100 models, your permissions will scale according to the size of your models.</p>
<p>The next thought came after much more considerable thinking - was to group permissions by feature. Permission A allowed creation of invoices; Permission B allowed management of access control. I managed to distill out 20 permissions. The defining of permissions should be deliberated as a permission should not be too general or it’ll lose it’s purpose, but neither should it be too specific then you’ll have too many permissions to handle and remember.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application_controller.rb</span></span><br><span class="line"><span class="keyword">attr_reader</span> <span class="symbol">:current_user</span></span><br><span class="line"><span class="keyword">include</span> CheckPermissions</span><br><span class="line"></span><br><span class="line"><span class="comment"># check_perimssions.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">CheckPermissions</span></span></span><br><span class="line">  extend ActiveSupport::Concern</span><br><span class="line"></span><br><span class="line">  included <span class="keyword">do</span></span><br><span class="line">    before_action <span class="symbol">:check_permission</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">permissions</span></span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="symbol">comments:</span> &#123;</span><br><span class="line">        <span class="symbol">index:</span> <span class="string">%w[ViewPost]</span>,</span><br><span class="line">        <span class="symbol">show:</span> <span class="string">%w[ViewPost]</span>,</span><br><span class="line">        <span class="symbol">create:</span> <span class="string">%w[PostComment]</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check_permission</span></span></span><br><span class="line">    controller_permissions = permissions[controller_name.to_sym][action_name.to_sym] <span class="params">||</span> []</span><br><span class="line">    user_permissions = current_user.permissions.uniq.pluck(<span class="symbol">:name</span>)</span><br><span class="line">    <span class="keyword">if</span> (controller_permissions &amp; user_permissions).empty?</span><br><span class="line">      <span class="comment"># If intersect of controller and user permissions is empty, user is not authorized</span></span><br><span class="line">      raise(ExceptionHandler::PermissionsError)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="Designing-the-Frontend"><a href="#Designing-the-Frontend" class="headerlink" title="Designing the Frontend"></a>Designing the Frontend</h2><p>First, ensure that api calls to the backend are accompanied by catch statements that will display errors if errors are thrown. And if possible, display the reason for the error. For react, I had to use <code>error.response.data.message</code> to distill the error message text.</p>
<p>This makes sure your application does not fail even if the current user is authenticated but not authorized to make certain api calls.</p>
<p>Next, I decided to change the display of the sidebar based on user’s role. Etc, if Role X has permissions to allow for User Management, and not Role Y, then Role Y should not be able to see a User tab in the sidebar.</p>
<p>For the frontend, I decided to use roles to differentiate rather than permissions, for ease and simplicity sake.</p>
<p>During authentication, I made a call to the backend to retrieve the user’s roles and save them. Not on a reducer as it’ll be wiped on a refresh, so localStorage/cookies would be sufficient.</p>
<p>Another matrix on the frontend, to display the corresponding sidebar. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ROLES = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Admin"</span>, <span class="attr">access</span>: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]&#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Manager"</span>, <span class="attr">access</span>: [<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>]&#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Employee"</span>, <span class="attr">access</span>: [<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>]&#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>Not the most clear, but it striked a balance between ease to implement and ease to understand.</p>
<p>Anddd that’s my story for implementing role based authorization. I had zero knowledge and confidence about doing this but I’m glad it worked out (for now haha)</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p><a href="https://www.atrium.co/inside-atrium/architecting-roles-permissions/" target="_blank" rel="noopener">Architecting Roles and Permissions, Atrium</a><br><a href="https://chunksofco.de/very-simple-api-permissions-in-rails-d37e21f09ff8" target="_blank" rel="noopener">Simple API Permissions</a></p>
</div><div class="tags"><a class="tag-link" href="/tags/rails/">rails</a><a class="tag-link" href="/tags/react/">react</a></div></section></div><div class="container"><ul class="nav"><li>Another one:<a href="/2020/03/13/Scraping-Social-Media-Comments/">Scraping Social Media Comments</a></li><li>Previous one:<a href="/2020/02/09/Learning-mint-lang/">Learning Mint-Lang</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-curry" target="_blank">Curry</a><span>.</span></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-109820124-3', 'auto');
ga('send', 'pageview');</script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>